(function(){var b=null;var j=null;var h=new Date().getTime();setInterval(function(){if(!window.tinyMCE||!tinyMCE.activeEditor){return}if(new Date().getTime()-h>150000&&tinyMCE.activeEditor.isDirty()){saveDraft()}},30000);var g=null;function a(l,m){if(g){clearTimeout(g)}var k=document.getElementById("saved_message");removeChildren(k);k.appendChild(document.createTextNode(l));k.style.display="inline";if(m){g=setTimeout(function(){k.style.display="none";g=null},3000)}}var i=setDirty;window.setDirty=function(k){return i(k)};window.saveDraft=function(){var k=tinyMCE.activeEditor;h=new Date().getTime();var m=k.getContent();if(!m||m==j){a(__["tinymce:no_unsaved_changes"],3000);return}var l=document.forms[0];a(__["tinymce:saving"]);var o=getXHR(function(p){window.save_draft_guid=p.guid;j=m;k.isNotDirty=true;a(__["tinymce:saved"],5000);setDirty(false)});o.open("POST",l.action,true);var n="_draft=1&content="+encodeURIComponent(m)+"&__ts="+l.__ts.value+"&__token="+l.__token.value;o.setRequestHeader("Content-Type","application/x-www-form-urlencoded");o.setRequestHeader("Content-Length",n.length);o.send(n)};function c(l){if(!tinyMCE.activeEditor.isDirty()||confirm(__["tinymce:restore_confirm"])){var k=tinyMCE.activeEditor;k.setContent(l.content);d()}}function f(l){b.style.display="none";var k=createElem("div",{className:"revisionPreview",innerHTML:__["tinymce:loading"]});var m=createModalBox({title:__["tinymce:preview_older"],okText:__["tinymce:restore"],focus:true,width:580,okFn:function(){removeElem(m);c(l)},cancelFn:function(){b.style.display="block";removeElem(m)},content:k});function n(q){var o=m.getElementsByTagName("input");var p=q?"inline":"none";o[0].style.display=p;o[1].style.display=p}n(false);document.body.appendChild(m);fetchJson("/pg/js_revision_content?id="+l.id,function(o){l.content=o.content;n(true);k.innerHTML=o.content},function(o){removeChildren(k);k.appendChild(document.createTextNode(o.error))})}function e(l,k){var m=createElem("div",{className:"revisionLink"},l+". ",createElem("a",{href:"javascript:void(0);",click:function(){ignoreDirty();setTimeout(function(){f(k)},1)}},k.friendly_time));return m}function d(){if(b){removeElem(b);b=null}}window.showOlderVersions=function(){var k=createElem("div",{className:"padded"});k.appendChild(document.createTextNode(__["tinymce:loading"]));d();b=createModalBox({title:__["tinymce:restoredraft_desc"],content:k,hideOk:true,cancelText:__["tinymce:close"]});document.body.appendChild(b);var l=getXHR(function(n){removeChildren(k);var o=n.revisions;if(o.length==0){k.appendChild(__["tinymce:no_revisions"])}else{if(o.length>15){k.style.height="246px";k.style.overflow="auto"}for(var m=0;m<o.length;m++){k.appendChild(e(o.length-m,o[m]))}}},function(m){removeChildren(k);k.appendChild(document.createTextNode(m.error))});l.open("GET","/pg/js_revisions?entity_guid="+window.save_draft_guid,true);l.send(null)}})();